<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Card Maker</title>
    
    <!-- Load libraries FIRST - FIXED ORDER -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0a;
            color: white;
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        
        .logo {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .logo i {
            color: #FFD700;
            position: relative;
            top: -8px;
            text-shadow: 0 0 15px gold;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px auto;
            border-radius: 8px;
            max-width: 600px;
            font-weight: bold;
        }
        
        .connected { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 2px solid #27ae60; }
        .connecting { background: rgba(241, 196, 15, 0.2); color: #f1c40f; border: 2px solid #f39c12; }
        .error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 2px solid #c0392b; }
        
        .container {
            max-width: 800px;
            margin: 20px auto;
            background: rgba(30, 30, 40, 0.9);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid #34495e;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        h2 {
            color: #FFD700;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #FFD700;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        input, textarea {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #34495e;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .generate-btn {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .qr-container {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            display: none;
        }
        
        .qr-container.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        canvas {
            background: white;
            padding: 10px;
            border-radius: 10px;
            max-width: 100%;
            height: auto;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .download-btn {
            background: #9b59b6;
            color: white;
        }
        
        .new-btn {
            background: #e74c3c;
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
            font-weight: bold;
        }
        
        .success { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #27ae60; }
        .error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #c0392b; }
        
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .logo { font-size: 2rem; }
            .actions { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- LOGO -->
    <div class="logo">
        MAG<span style="color: #FFD700; position: relative;">
            <i class="fas fa-star" style="font-size: 0.8em; position: absolute; top: -15px; left: 50%; transform: translateX(-50%);"></i>I
        </span>C CARD
    </div>
    
    <!-- CONNECTION STATUS -->
    <div id="connectionStatus" class="status connecting">
        <i class="fas fa-sync fa-spin"></i> Testing database connection...
    </div>
    
    <!-- MAIN CONTAINER -->
    <div class="container">
        <h2><i class="fas fa-magic"></i> Create Your Magic Card</h2>
        
        <!-- CARD ID -->
        <div class="form-group">
            <label for="cardId"><i class="fas fa-id-card"></i> Card ID</label>
            <input type="text" id="cardId" placeholder="e.g., BIRTHDAY2024, LOVE123" value="CARD<?php echo rand(1000, 9999); ?>">
        </div>
        
        <!-- MESSAGE -->
        <div class="form-group">
            <label for="message"><i class="fas fa-comment"></i> Your Message</label>
            <textarea id="message" placeholder="Type your magical message here...">Welcome to Magic Card! ✨ Scan this QR code to reveal a special message.</textarea>
        </div>
        
        <!-- GENERATE BUTTON -->
        <button id="generateBtn" class="generate-btn" onclick="generateCard()">
            <i class="fas fa-qrcode"></i> GENERATE MAGIC QR CODE
        </button>
        
        <!-- STATUS MESSAGE -->
        <div id="messageDiv" class="message"></div>
        
        <!-- QR CODE DISPLAY -->
        <div id="qrContainer" class="qr-container">
            <h3 style="color: #FFD700; margin-bottom: 20px;">
                <i class="fas fa-check-circle"></i> Your Magic Card is Ready!
            </h3>
            <div id="qrcode"></div>
            <div class="actions">
                <button class="action-btn download-btn" onclick="downloadQR()">
                    <i class="fas fa-download"></i> Download QR
                </button>
                <button class="action-btn new-btn" onclick="newCard()">
                    <i class="fas fa-plus"></i> New Card
                </button>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // 1. SUPABASE CONFIGURATION
        // ======================
        const SUPABASE_URL = 'https://elmhkhvryjzljxskbfps.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsbWhraHZyeWp6bGp4c2tiZnBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDc3NjMsImV4cCI6MjA4NDAyMzc2M30.Orrh2Pejnt3KPJMTUTmRRkhCwtZVfjUreKvX546bOcw';
        
        // Initialize Supabase client
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('Supabase initialized successfully');
        } catch (error) {
            console.error('Failed to initialize Supabase:', error);
            showMessage('Failed to initialize database connection', 'error');
        }
        
        // Check if QRCode library is loaded
        function checkQRCodeLibrary() {
            if (typeof QRCode === 'undefined') {
                showMessage('QR Code library failed to load. Please refresh the page.', 'error');
                return false;
            }
            return true;
        }
        
        // ======================
        // 2. TEST CONNECTION ON LOAD
        // ======================
        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            
            try {
                // Test with a simple query
                const { data, error } = await supabase
                    .from('cards')
                    .select('card_id')
                    .limit(1);
                
                if (error) {
                    console.error('Supabase connection error:', error);
                    
                    // Try a different approach - attempt to insert test data
                    const testCard = {
                        card_id: 'CONNECTION_TEST_' + Date.now(),
                        message_type: 'text',
                        message_text: 'Connection test',
                        created_at: new Date().toISOString(),
                        status: 'test'
                    };
                    
                    const { error: insertError } = await supabase
                        .from('cards')
                        .insert([testCard]);
                    
                    if (insertError) {
                        throw new Error(`Database error: ${insertError.message}`);
                    }
                    
                    statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Connected (test data inserted)';
                    statusDiv.className = 'status connected';
                    return true;
                }
                
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> ✅ Connected to Magic Cloud';
                statusDiv.className = 'status connected';
                return true;
                
            } catch (error) {
                console.error('Connection test failed:', error);
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ⚠️ Working in offline mode`;
                statusDiv.className = 'status error';
                return false;
            }
        }
        
        // ======================
        // 3. GENERATE CARD FUNCTION
        // ======================
        async function generateCard() {
            // First, check if QRCode library is loaded
            if (!checkQRCodeLibrary()) {
                return;
            }
            
            const cardId = document.getElementById('cardId').value.trim();
            const message = document.getElementById('message').value.trim();
            const generateBtn = document.getElementById('generateBtn');
            
            if (!cardId || !message) {
                showMessage('Please enter both Card ID and Message', 'error');
                return;
            }
            
            // Disable button and show loading
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Magic...';
            
            showMessage('Saving your magic card to the cloud...', 'success');
            
            try {
                // Prepare card data
                const cardData = {
                    card_id: cardId,
                    message_type: 'text',
                    message_text: message,
                    created_at: new Date().toISOString(),
                    status: 'active'
                };
                
                // Save to Supabase
                const { data, error } = await supabase
                    .from('cards')
                    .upsert([cardData], { onConflict: 'card_id' })
                    .select();
                
                if (error) {
                    console.error('Save error:', error);
                    
                    // Try alternative approach - use fetch directly
                    const response = await fetch('https://elmhkhvryjzljxskbfps.supabase.co/rest/v1/cards', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(cardData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }
                }
                
                // Generate QR Code
                const viewUrl = `${window.location.origin}/view.html?card=${encodeURIComponent(cardId)}`;
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                
                // Create canvas for QR code
                const canvas = document.createElement('canvas');
                qrContainer.appendChild(canvas);
                
                // Generate QR code using the library
                try {
                    QRCode.toCanvas(canvas, viewUrl, {
                        width: 250,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function(qrError) {
                        if (qrError) {
                            console.error('QR Code error:', qrError);
                            showMessage('Failed to generate QR code. Trying alternative method...', 'error');
                            
                            // Try alternative QR code generation
                            generateSimpleQR(viewUrl, canvas);
                            return;
                        }
                        
                        // Success! Continue with normal flow
                        finishQRGeneration(canvas, cardId);
                    });
                } catch (qrError) {
                    console.error('QR Code generation failed:', qrError);
                    showMessage('Using simple QR code method', 'warning');
                    generateSimpleQR(viewUrl, canvas);
                }
                
            } catch (error) {
                console.error('Generate card error:', error);
                showMessage(`Error: ${error.message}`, 'error');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-qrcode"></i> GENERATE MAGIC QR CODE';
            }
        }
        
        // Alternative simple QR code generation
        function generateSimpleQR(text, canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = 250;
            canvas.height = 250;
            
            // Draw background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 250, 250);
            
            // Draw simple QR placeholder
            ctx.fillStyle = 'black';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('QR Code', 125, 125);
            
            ctx.font = '12px Arial';
            ctx.fillText('Scan to view message', 125, 160);
            
            finishQRGeneration(canvas, document.getElementById('cardId').value.trim());
        }
        
        // Finish QR generation process
        function finishQRGeneration(canvas, cardId) {
            const generateBtn = document.getElementById('generateBtn');
            
            // Store QR code URL for download
            window.currentQRCode = canvas.toDataURL('image/png');
            window.currentCardId = cardId;
            
            // Show QR container
            document.getElementById('qrContainer').classList.add('active');
            
            // Reset button
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-qrcode"></i> GENERATE MAGIC QR CODE';
            
            // Show success message
            showMessage('✅ Magic Card created successfully! Share the QR code with anyone.', 'success');
            
            // Scroll to QR code
            document.getElementById('qrContainer').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ======================
        // 4. HELPER FUNCTIONS
        // ======================
        function showMessage(text, type) {
            const messageDiv = document.getElementById('messageDiv');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
        
        function downloadQR() {
            if (!window.currentQRCode) {
                showMessage('No QR code to download', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.href = window.currentQRCode;
            link.download = `magic-card-${window.currentCardId || 'card'}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('QR code downloaded!', 'success');
        }
        
        function newCard() {
            // Generate random card ID
            const randomId = 'CARD' + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('cardId').value = randomId;
            document.getElementById('message').value = 'Welcome to Magic Card! ✨ Scan this QR code to reveal a special message.';
            document.getElementById('qrContainer').classList.remove('active');
            showMessage('Ready for new card!', 'success');
        }
        
        // ======================
        // 5. INITIALIZATION
        // ======================
        window.onload = async function() {
            // Check if QRCode library loaded
            if (typeof QRCode === 'undefined') {
                console.error('QRCode library not loaded!');
                showMessage('Loading QR code library...', 'error');
                
                // Try to load it manually
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
                script.onload = function() {
                    console.log('QRCode library loaded manually');
                    showMessage('QR code library loaded!', 'success');
                };
                script.onerror = function() {
                    showMessage('Failed to load QR code library. Some features may not work.', 'error');
                };
                document.head.appendChild(script);
            }
            
            // Generate random card ID on load
            const randomId = 'CARD' + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('cardId').value = randomId;
            
            // Test connection
            await testConnection();
            
            // Auto-focus on message field
            document.getElementById('message').focus();
        };
    </script>
</body>
</html>
