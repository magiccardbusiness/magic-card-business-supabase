<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Magic Card - View Message</title>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: black; 
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            color: white;
            padding: 20px;
        }
        
        /* Company Logo */
        #company-logo {
            text-align: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-top: 10px;
        }
        
        .magic-i {
            position: relative;
            display: inline-block;
            color: #FFD700;
        }
        
        .magic-i::before {
            content: "‚òÖ";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #FFD700;
        }
        
        /* Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            border: 1px solid #34495E;
            padding: 20px;
            margin-top: 20px;
        }
        
        /* Connection Status */
        .connection-status {
            text-align: center;
            font-size: 14px;
            color: #27AE60;
            margin-bottom: 10px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Message Display */
        .message-box {
            background: rgba(44, 62, 80, 0.8);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #34495E;
            text-align: center;
        }
        
        /* Status Messages */
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .success { 
            background: rgba(39, 174, 96, 0.2); 
            color: #27AE60; 
            border: 1px solid #27AE60; 
        }
        
        .error { 
            background: rgba(231, 76, 60, 0.2); 
            color: #E74C3C; 
            border: 1px solid #E74C3C; 
        }
    </style>
</head>
<body>
    <!-- YOUR BEAUTIFUL LOGO -->
    <div id="company-logo">
        MAG<span class="magic-i">I</span>C CARD
    </div>
    
    <div class="connection-status" id="connectionStatus">
        üîÑ Connecting to cloud...
    </div>
    
    <div class="container">
        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <p>Checking for messages...</p>
        </div>
        
        <div id="messageBox" class="message-box" style="display: none;">
            <h2 style="color: #FFD700;">‚ú® Your Magic Message ‚ú®</h2>
            <div id="messageContent" style="margin: 20px 0; font-size: 18px;"></div>
            <p style="color: #AAAAAA; font-size: 14px;">
                <i class="fas fa-qrcode"></i> Scanned from Magic Card QR
            </p>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        // ======================
        // SUPABASE - ONLY ONE DECLARATION!
        // ======================
        const supabaseUrl = 'https://elmhkhvryjzljxskbfps.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsbWhraHZyeWp6bGp4c2tiZnBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDc3NjMsImV4cCI6MjA4NDAyMzc2M30.Orrh2Pejnt3KPJMTUTmRRkhCwtZVfjUreKvX546bOcw';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // ======================
        // 1. TEST CONNECTION
        // ======================
        async function testConnection() {
            try {
                const { data, error } = await supabase
                    .from('cards')
                    .select('card_id')
                    .limit(1);
                
                if (error) {
                    console.error('Connection error:', error);
                    document.getElementById('connectionStatus').textContent = 
                        "‚ö†Ô∏è Connection issue - trying anyway";
                    document.getElementById('connectionStatus').style.color = "#F39C12";
                    return false;
                }
                
                document.getElementById('connectionStatus').textContent = 
                    "‚úÖ Connected to cloud";
                document.getElementById('connectionStatus').style.color = "#27AE60";
                return true;
                
            } catch (error) {
                console.error('Test failed:', error);
                document.getElementById('connectionStatus').textContent = 
                    "‚ùå Connection failed";
                document.getElementById('connectionStatus').style.color = "#E74C3C";
                return false;
            }
        }
        
        // ======================
        // 2. GET CARD ID FROM URL
        // ======================
        function getCardIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            let cardId = urlParams.get('card');
            
            if (!cardId) {
                // For testing, use a demo card
                cardId = 'DEMO-CARD';
                showStatus('Using demo card. Add ?card=YOUR_CARD_ID to URL', 'success');
            }
            
            return cardId;
        }
        
        // ======================
        // 3. LOAD MESSAGE
        // ======================
        async function loadMessage() {
            const cardId = getCardIdFromUrl();
            
            try {
                const { data, error } = await supabase
                    .from('cards')
                    .select('*')
                    .eq('card_id', cardId)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (error || !data) {
                    document.getElementById('messageContent').innerHTML = 
                        `<p>No message found for card: <strong>${cardId}</strong></p>
                         <p style="color: #FFD700; margin-top: 15px;">
                            <i class="fas fa-info-circle"></i> 
                            This card hasn't been set up yet.
                         </p>`;
                } else {
                    // Display the message
                    let messageHtml = '';
                    
                    if (data.message_type === 'text' && data.message_text) {
                        messageHtml = `
                            <div style="
                                background: rgba(255,215,0,0.1);
                                padding: 20px;
                                border-radius: 10px;
                                border-left: 4px solid #FFD700;
                                text-align: left;
                            ">
                                ${data.message_text.replace(/\n/g, '<br>')}
                            </div>
                            <p style="margin-top: 15px; color: #AAAAAA; font-size: 14px;">
                                <i class="fas fa-calendar"></i> 
                                Created: ${new Date(data.created_at).toLocaleDateString()}
                            </p>`;
                    } else if (data.message_type === 'image') {
                        messageHtml = `<p>üñºÔ∏è Image message: ${data.file_name || 'Image card'}</p>`;
                    } else if (data.message_type === 'video') {
                        messageHtml = `<p>üé¨ Video message: ${data.file_name || 'Video card'}</p>`;
                    } else {
                        messageHtml = `<p>‚ú® Magic message!</p>`;
                    }
                    
                    document.getElementById('messageContent').innerHTML = messageHtml;
                }
                
                // Show message box
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('messageBox').style.display = 'block';
                
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('messageContent').innerHTML = 
                    `<p>Error loading message. Try again later.</p>`;
                document.getElementById('messageBox').style.display = 'block';
            }
        }
        
        // ======================
        // 4. STATUS MESSAGES
        // ======================
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            setTimeout(() => { 
                statusDiv.style.display = 'none'; 
            }, 5000);
        }
        
        // ======================
        // 5. INITIALIZE
        // ======================
        window.onload = async function() {
            await testConnection();
            await loadMessage();
        };
    </script>
</body>
</html>
